<!DOCTYPE html>
<html>
<meta charset="utf-8">

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script type="text/javascript" src="re.js"></script>
<script type="text/javascript" src="d3.js"></script>
<script type="text/javascript" src="drag.js"></script>
<link rel="stylesheet" type="text/css" href="style.css">

<body>
        <div class="container">
            <h3 class="text-muted">台灣股市歷史事件</h3>
        </div>
          
        <div class="jumbotron"></div>
          
    <div id = 'rect_know'>確定</div>
    <div id = 'rect_illu'></div>
    
    <button id='test' onclick="retest()">test</button>
    <script>
        var width = 1050;
        var height = 530;
        var lower_width = 1050;
        var lower_height = 100;


        var check_happen_text = 0;

        var rect_news = d3.select('body').append("div")
                            .style({
                                'border':'1px solid #000',
                                'height':'200px',
                                'width':'120px',
                                'color':'red',
                                'z-index':50
                                });
         
        var zoom = d3.zoom()
            .scaleExtent([1, Infinity])
            .translateExtent([[0, 0], [width, height]])
            .extent([[0, 0], [width, height]])
            .on("zoom",zoomed)

        var svg = d3.select(".jumbotron").append("svg")
            .attr("width", width)
            .attr("height", 650).call(zoom);
        var g = svg.append("g")
            .attr("transform", "translate(0,0)");
        
        var parseTime = d3.timeParse("%d-%b-%y");//d3的時間格式%d=日,%b=月,%y=年
        var time_format = d3.timeFormat("%Y-%m-%d");
        var dig_format = d3.format(".0f");

        var colorScale = d3.scaleLinear()
            .domain([0, 60])
            .range(["gray", "black"]);

        var bisectDate = d3.bisector(function (d) { return d.date; }).left;
        //////////////////////////////
        var chart = svg.append("g")
            .attr("class","charts");//main chart

        var lower_chart = svg.append("g")
           .attr("transform", "translate(0,550)");//height - lower_height

        ///////////////////////////////折線圖的範圍
        var x = d3.scaleTime()
            .range([0, width]);

        var y = d3.scaleLinear()
            .rangeRound([height, 0]);

        var line = d3.line()
            .x(function (d) { return x(d.date); })
            .y(function (d) { return y(d.price); })

        var bar_scale = d3.scaleLinear()
            .domain([0, 60])
            .range([0, 300]);
        ///////////////////////////////lower chart
        var lower_x = d3.scaleTime()
            .rangeRound([0, lower_width]);

        var lower_y = d3.scaleLinear()
            .rangeRound([lower_height, 0]);

        var lower_line = d3.line()
            .x(function (d) { return lower_x(d.date); })
            .y(function (d) { return lower_y(d.price); });

        var lower_data = d3.area()
            .x(function(d){return lower_x(d.date);})
            .y0(630)
            .y1(function(d){return lower_y(d.price);});
        ///////////////////////////////
        var xAxis = d3.axisBottom(x);

        var yAxis = d3.axisLeft(y);
        ///////////////////////////////brush and zoom

        var brush = d3.brushX()
            .extent([[0, 0], [lower_width,lower_height]])
            .on("brush end",brushed);
        ///////////////////////////////
        d3.json("happen.json",function(happen_data){
            d3.csv("temp_data.csv", function (d) {//折線圖的資料輸入
                d.date = new Date(d.date);
                d.price = +parseInt(d.price);
                return d;
            }, function (error, data) {
                if (error) { throw error; }

                console.log(data[bisectDate(data,happen_data[0].date,1)]);//發生的事轉日期和價格

                x.domain(d3.extent(data, function (d) { return d.date; }));
                y.domain(d3.extent(data, function (d) { return d.price; }));

                lower_x.domain(d3.extent(data, function (d) { return d.date; }));
                lower_y.domain(d3.extent(data, function (d) { return d.price; }));

                chart.append("g")
                    .attr("class", "axis_x")
                    .attr("transform", "translate(0,500)")
                    .call(xAxis)
                    .select(".domain")
                    .remove();

                chart.append("g")
                    .attr("class", "axis_y")
                    .call(yAxis)
                    .append("text")
                    .attr("fill", "#000")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 6)
                    .attr("dy", "0.71em")
                    .attr("text-anchor", "end")
                    .text("Price($)");

                chart.append("g")
                    .attr("class", "path")
                    .call(yAxis.ticks(10).tickFormat("").tickSize(-1050, 0))
                    .attr("fill", "none")
                    .attr("stroke", "rgba(0,0,0,.1)")
                    .attr("opacity", 0.3)
                    .attr("transform", "translate(0,-30)")
                    .style("pointer-events", "none");

                var rect_info = chart.append("rect")
                    .attr("class", "check_rect_info")
                    .attr("x", 0)
                    .attr("y", 0)
                    .attr("width", 0)
                    .attr("height", 0)
                    .attr("rx", 10)//圓弧
                    .attr("ry", 10)
                    .attr("opacity", 0.5)
                    .attr("fill", "gray");

                var rect_info_text = chart
                    .append("text")
                    .attr("class", "check_rect_info_text")
                    .attr("fill", "black")
                    .attr("y", 0)
                    .attr("x", 0)
                    .attr("dy", "1em")
                    .attr("font-size", "0px")
                    .attr("text-anchor", "middle");

                var circle_mouse = chart.append("circle")
                    .attr("class", "check_circle_mouse")
                    .data(data)
                    .attr("r", 5)
                    .attr("fill", "steelblue")
                    .attr("cx", 0)
                    .attr("cy", 0);

                var check_line = chart.append("line")
                    .attr("class", "check_check_line")
                    .attr("x1", 0)
                    .attr("y1", 0)
                    .attr("x2", width)
                    .attr("y2", 0)
                    .attr("stroke", "black")
                    .attr("stroke-width", 0.5);

                var check_line_1 = chart.append("line")
                    .attr("class", "check_check_line_1")
                    .attr("x1", 0)
                    .attr("y1", 0)
                    .attr("x2", 0)
                    .attr("y2",500  )
                    .attr("stroke", "black")
                    .attr("stroke-width", 0.5);

                var date_data = d3.map(data, function (d) { return d.date; })//可以將數據做轉換

                var mouse_offset = 250;

                svg//隨著滑鼠照著折線圖移動
                    .on("mousemove", function (d) {

                        var date_x = bisectDate(data, x.invert(d3.event.x-mouse_offset), 1);//將座標轉換成x軸的資料的index，invert將座標轉換成x軸資料
                        var date_obj = data[date_x];//利用index拿到x軸座標的資料物件
                        var temp = data[bisectDate(data,happen_data[0].date,1)];

                        circle_mouse
                            .attr("cx", d3.event.x-mouse_offset)
                            .attr("cy", function (d, i) {
                                return y(date_obj.price)
                            });//從data陣列中取出該座標對應的price的值
                        check_line
                            .attr("y1", y(date_obj.price))
                            .attr("y2", y(date_obj.price));
                        check_line_1
                            .attr("x1", d3.event.x-mouse_offset)
                            .attr("x2", d3.event.x-mouse_offset);
                        rect_info
                            .attr("x", d3.event.x-mouse_offset)
                            .attr("y", y(date_obj.price))
                            .attr("width", 100)
                            .attr("height", 60);
                        rect_info_text
                            .attr("y", y(date_obj.price) + 15)
                            .attr("font-size", "13px")
                            .attr("x", d3.event.x-mouse_offset+50)
                            .text(function (d) { return date_obj.date.toLocaleString().substr(0, 8) + " " + date_obj.price; });
                    })

                chart.append("path")
                    .datum(data)
                    .attr("class", "line")
                    .attr("fill", "none")
                    .attr("stroke", "steelblue")
                    .attr("stroke-linejoin", "round")
                    .attr("stroke-linecap", "round")
                    .attr("stroke-width", 0)
                    .attr("d", line)
                    .on("mouseout", function (e) {
                    })
                    .transition().duration(1000).delay(200).attr("stroke-width", 1.5);
                
                var lower_path = lower_chart.append("path")
                    .datum(data)
                    .attr("class", "line")
                    .attr("fill", "none")
                    .attr("stroke", "steelblue")
                    .attr("stroke-linejoin", "round")
                    .attr("stroke-linecap", "round")
                    .attr("stroke-width", 1.5)
                    .attr("d", lower_line)
                    .transition().duration(1000).delay(200).attr("stroke-width", 1.5);
            

                var temp = chart.selectAll("circle.bars")   
                    .data(happen_data)
                    .enter()
                    .append("circle") 
                    .attr("class", "bars")
                    .attr("r", "5")
                    .attr("fill", "orange")
                    .style("cursor","pointer")
                    .attr("cx", function (d) { return x(new Date(d.date))})
                    .attr("cy", function (d) { return y(d.price)})
                    .on("mouseover",function(d){ 
                            d3.select(this)
                            .attr("r","8")
                            .attr("fill","yellow")                           
                            d3.select('#rect_illu')
                            .style("width","20%")
                            .style("height","200px");
                            d3.select('#rect_illu').append('text')
                                .attr("fill", "black")
                                .attr("y", 0)
                                .attr("x", 0)
                                .attr("dy", "1em")
                                .attr("font-size", "10px")
                                .attr("text-anchor", "middle")
                                .text(d.content);
                            console.log(d.content);
                    })
                    .on("mouseout",function(d){
                        d3.select(this)
                        .attr("r","5")
                        .attr("fill","orange") 
                       d3.select('#rect_illu').select("text").remove();     
                            d3.select('#rect_illu')
                                .style("width","0")
                                .style("height","0");
                    })
                    .on("click",function(d){
                        window.open(d.web)
                    });
               
                lower_chart.append("path")
                    .datum(data)
                    .attr("class","line")
                    .attr("fill","lightblue")
                    .attr("d",lower_data(data));
                
            lower_chart.append("g")
                    .attr("class","brush")
                    .call(brush)
                    .call(brush.move,x.range());
            
            });
        });

        ///////////////////////////////////////////////
        function zoomed(){
            if(d3.event.sourceEvent && d3.event.sourceEvent.type === "brush")return;
            
            var t = d3.event.transform;
            console.log(d3.event.transform);
            x.domain(t.rescaleX(lower_x).domain());
            chart.selectAll(".bars").attr("cx", function (d) { return x(new Date(d.date))})
            chart.select(".line").attr("d",line);
            chart.select(".axis_x").call(xAxis);
            d3.select(".brush").call(brush.move,x.range().map(t.invertX,t));

        }
        function brushed(){
            if(d3.event.sourceEvent && d3.event.sourceEvent.type === "zoom")return;//用三個=不會有轉型的問題
            var s = d3.event.selection || lower_x.range();
            console.log(s);
            x.domain(s.map(lower_x.invert,lower_x));
            chart.selectAll(".bars").attr("cx", function (d) { return x(new Date(d.date))})
            chart.select(".line").attr("d",line);
            chart.select(".axis_x").call(xAxis);
            svg.select(".zoom").call(zoom.transform,d3.zoomIdentity
                .scale(width/(s[1]-s[0]))
                .translate(-s[0],0));
        }
    </script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js" integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js" integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script>
</body>

</html>